from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException
import time

BASE_URL = "http://localhost:5173"
LOGIN_URL = f"{BASE_URL}/login"

TEST_USER = "alumno1"
TEST_PASS = "123456"

MODULES = [
    ("Usuarios", "/app/usuarios"),
    ("Videojuego", "/app/videojuego"),
    ("Resultados", "/app/resultados"),
]

WAIT_SECONDS = 15


def crear_driver():
    options = webdriver.ChromeOptions()
    options.add_argument("--start-maximized")
    driver = webdriver.Chrome(options=options)
    return driver


def login(driver):
    wait = WebDriverWait(driver, WAIT_SECONDS)

    print(f"[INFO] Abriendo página de login: {LOGIN_URL}")
    driver.get(LOGIN_URL)

    try:
        user_input = wait.until(
            EC.presence_of_element_located(
                (By.CSS_SELECTOR, "input[type='email'], input[type='text']")
            )
        )
        password_input = wait.until(
            EC.presence_of_element_located(
                (By.CSS_SELECTOR, "input[type='password']")
            )
        )
    except TimeoutException:
        print("[ERROR] No se encontraron los campos de usuario/contraseña.")
        raise

    user_input.clear()
    user_input.send_keys(TEST_USER)

    password_input.clear()
    password_input.send_keys(TEST_PASS)

    try:
        login_button = driver.find_element(By.CSS_SELECTOR, "button[type='submit']")
    except Exception:
        login_button = driver.find_element(By.XPATH, "//button[contains(., 'Iniciar')]")

    print("[INFO] Haciendo clic en 'Iniciar sesión'...")
    login_button.click()

    try:
        wait.until(EC.url_contains("/app/"))
        print(f"[OK] Login exitoso. URL actual: {driver.current_url}")
    except TimeoutException:
        print("[ERROR] No se redirigió al área /app/. ¿Hay 2FA o falló el login?")
        raise


def ir_a_modulo(driver, link_text, url_fragment):
    wait = WebDriverWait(driver, WAIT_SECONDS)

    print(f"\n[INFO] Navegando al módulo: {link_text}")
    try:
        nav_link = wait.until(
            EC.element_to_be_clickable((By.LINK_TEXT, link_text))
        )
        nav_link.click()
    except TimeoutException:
        print(f"[ERROR] No se encontró el link '{link_text}' en el menú.")
        return False

    try:
        wait.until(EC.url_contains(url_fragment))
        print(f"[OK] Módulo '{link_text}' cargado. URL: {driver.current_url}")
        time.sleep(2)
        return True
    except TimeoutException:
        print(
            f"[ERROR] Al hacer clic en '{link_text}' la URL no contiene '{url_fragment}'. "
            f"URL actual: {driver.current_url}"
        )
        return False


def main():
    driver = crear_driver()
    try:
        login(driver)

        resultados = []
        for nombre, url_frag in MODULES:
            ok = ir_a_modulo(driver, nombre, url_frag)
            resultados.append((nombre, ok))

        print("\n========== RESUMEN DE LA NAVEGACIÓN ==========")
        for nombre, ok in resultados:
            estado = "OK" if ok else "FALLÓ"
            print(f"- {nombre}: {estado}")

    finally:
        print("\n[INFO] Cerrando navegador...")
        driver.quit()


if __name__ == "__main__":
    main()
